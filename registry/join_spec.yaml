# ⚠️ CRITICAL: NO FAKE DATA ⚠️
# This project uses ONLY real, verified data sources. NO placeholders, NO synthetic data, NO fake values.
# All data must come from authenticated APIs, official sources, or validated historical records.
#

version: "1.1"
description: "Declarative join specification with automated tests for 25-year data pipeline - UPDATED FOR FRESH START (prefixed columns, granular formats)"
last_updated: "2025-11-17"

joins:
  # === BASE: Yahoo Historical Data (ZL=F ONLY - Alpha is TOTALLY SEPARATE, no ZL data) ===
  - name: "base_prices"
    source: "staging/yahoo_historical_prefixed.parquet"
    tests:
      - expect_date_range: ["2000-03-15", "2025-01-01"]  # ZL futures started March 15, 2000
      - expect_symbols_count_gte: 1  # Changed from 55 - ZL=F ONLY now
      - expect_zl_rows_gte: 6000
      - expect_columns_prefixed: ["yahoo_"]  # All columns except date, symbol should have yahoo_ prefix

  # === JOIN: FRED Macro Data (PREFIXED) ===
  - name: "add_macro"
    left: "<<base_prices>>"
    right: "staging/fred_macro_expanded.parquet"  # UPDATED: New filename
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"
    tests:
      - expect_rows_preserved
      - expect_columns_added: ["fred_fed_funds_rate", "fred_vix", "fred_treasury_10y", "fred_usd_broad_index"]  # UPDATED: Prefixed columns
      - expect_null_rate_below: {"fred_fed_funds_rate": 0.05, "fred_vix": 0.05}

  # === JOIN: Weather Data (GRANULAR WIDE FORMAT) ===
  - name: "add_weather"
    left: "<<add_macro>>"
    right: "staging/weather_granular.parquet"  # UPDATED: New filename (granular format)
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill: {"weather_us_iowa_PRCP": 0.0, "weather_us_iowa_TAVG": 10.0}  # UPDATED: Use actual NOAA column names (uppercase)
    tests:
      - expect_rows_preserved
      - expect_null_rate_below: {"weather_us_iowa_PRCP": 0.30}  # UPDATED: Use actual NOAA column name
      - expect_columns_added: ["weather_us_iowa_TAVG", "weather_us_illinois_TAVG"]  # Verify granular columns exist

  # === JOIN: CFTC Positioning (2020+) (PREFIXED) ===
  # NOTE: Using existing cftc_commitments.parquet (2020-2024). Full 2006-2025 backfill pending.
  - name: "add_cftc"
    left: "<<add_weather>>"
    right: "staging/cftc_commitments.parquet"
    on: ["date"]
    how: "left"
    null_policy:
      allow: true  # Only available 2020+
      fill: {}
    tests:
      - expect_rows_preserved
      - expect_cftc_available_after: "2015-01-01"  # Updated after backfill  # Updated: actual data starts 2020, not 2006
      - expect_columns_prefixed: ["cftc_"]  # All columns except date should have cftc_ prefix

  # === JOIN: USDA Data (GRANULAR WIDE FORMAT) ===
  - name: "add_usda"
    left: "<<add_cftc>>"
    right: "staging/usda_reports_granular.parquet"  # UPDATED: New filename (granular format)
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"
    tests:
      - expect_rows_preserved
      - expect_columns_prefixed: ["usda_"]  # All columns except date should have usda_ prefix

  # === JOIN: EIA Energy Data (GRANULAR WIDE FORMAT) ===
  - name: "add_eia"
    left: "<<add_usda>>"
    right: "staging/eia_energy_granular.parquet"  # UPDATED: New filename (granular format)
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill: {}
    tests:
      - expect_rows_preserved
      - expect_columns_prefixed: ["eia_"]  # All columns except date should have eia_ prefix

  # === JOIN: Final Regime Weights ===
  - name: "add_regimes"
    left: "<<add_eia>>"
    right: "registry/regime_calendar.parquet" # Note: using the registry file directly
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"
    tests:
      - expect_rows_preserved
      - expect_columns_added: ["regime", "training_weight"]  # Updated: regime_calendar.parquet has 'training_weight', not separate vol/eng/garch weights

  # === JOIN: Volatility & VIX ===
  - name: "add_volatility"
    left: "<<add_regimes>>"
    right: "staging/volatility_features.parquet"
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"
    tests:
      - expect_rows_preserved
      - expect_columns_prefixed: ["vol_"]
      - expect_columns_added: ["vol_vix_level", "vol_regime"]

  # === JOIN: Palm Oil (Barchart) ===
  - name: "add_palm"
    left: "<<add_volatility>>"
    right: "staging/palm_oil_daily.parquet"
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"
    tests:
      - expect_rows_preserved
      - expect_columns_prefixed: ["barchart_palm_"]

  # === JOIN: Policy & Trump Intelligence ===
  - name: "add_policy_trump"
    left: "<<add_palm>>"
    right: "staging/policy_trump_signals.parquet"
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"  # Policy signals persist until new announcement
    tests:
      - expect_rows_preserved
      - expect_columns_prefixed: ["policy_trump_"]
  
  # === JOIN: ES Futures (25 years + 50+ technical indicators) ===
  - name: "add_es_futures"
    left: "<<add_policy_trump>>"
    right: "staging/es_futures_daily.parquet"
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"  # ES data available from 2000-11-24
    tests:
      - expect_rows_preserved
      - expect_columns_prefixed: ["es_"]
      - expect_columns_added: ["es_close"]

  # === JOIN: ES Intraday Aggregated Features ===
  - name: "add_es_intraday_features"
    left: "<<add_es_futures>>"
    right: "staging/es_daily_aggregated.parquet"
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"
    tests:
      - expect_rows_preserved
      - expect_columns_added: ["es_5min_realized_vol", "es_30min_realized_vol", "es_60min_realized_vol"] # Sample of new features

  # === JOIN: 9-Layer Sentiment Daily (Production - Verified Nov 19, 2025) ===
  - name: "add_sentiment"
    left: "<<add_es_intraday_features>>"
    right: "staging/sentiment_daily.parquet"
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"  # Sentiment signals persist until new calculation
    tests:
      - expect_rows_preserved
      - expect_columns_added: ["procurement_sentiment_index", "core_zl_price_sentiment", "biofuel_policy_sentiment", "geopolitical_tariff_sentiment"]
      - expect_columns_added: ["tariff_pinball", "rin_moon_pinball", "drought_pinball"]

  # === JOIN: MES Futures (daily) ===
  - name: "add_mes_futures"
    left: "<<add_es_intraday_features>>"
    right: "staging/mes_futures_daily.parquet"
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"
    tests:
      - expect_rows_preserved
      - expect_columns_prefixed: ["mes_"]
      - expect_columns_added: ["mes_close"]

  # === JOIN: MES Intraday Aggregated Features ===
  - name: "add_mes_intraday_features"
    left: "<<add_mes_futures>>"
    right: "staging/mes_daily_aggregated.parquet"
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"
    tests:
      - expect_rows_preserved
      - expect_columns_added: ["mes_5min_realized_vol", "mes_30min_realized_vol", "mes_60min_realized_vol", "mes_240min_realized_vol"]

  # === JOIN: MES Correlation Confirmation Features (VIX/USD/10Y) ===
  - name: "add_mes_confirmation_features"
    left: "<<add_mes_intraday_features>>"
    right: "staging/mes_confirmation_features.parquet"
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"
    tests:
      - expect_rows_preserved
      - expect_columns_added: ["mes_corr_vix_ret_30d", "mes_corr_usd_ret_30d", "mes_corr_t10y_ret_30d"]

  # === JOIN: ZL Intraday Aggregated Features (from Databento) ===
  - name: "add_zl_intraday_features"
    left: "<<add_mes_intraday_features>>"
    right: "staging/zl_daily_aggregated.parquet"
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"
    tests:
      - expect_rows_preserved
      - expect_columns_added: ["zl_60min_realized_vol", "zl_60min_hl_vol", "zl_60min_vwap"]

# === FINAL TESTS (Must Pass Before Feature Engineering) ===
final_tests:
  - expect_total_rows_gte: 6000
  - expect_total_cols_gte: 100
  - expect_no_duplicate_dates
  - expect_date_range: ["2000-03-15", "2025-11-14"]  # Updated: ZL=F trading started March 15, 2000; end date matches current data availability
  - expect_regime_cardinality_gte: 7
  - expect_weight_range: [50, 1000]  # Updated Nov 17, 2025: Changed from 50-5000 to 50-1000
  - expect_columns_present: ["es_5min_realized_vol", "es_30min_realized_vol", "es_60min_realized_vol"]




