version: "1.1"
description: "Declarative join specification with automated tests for 25-year data pipeline - UPDATED FOR FRESH START (prefixed columns, granular formats)"
last_updated: "2025-11-17"

joins:
  # === BASE: Yahoo Historical Data (ZL=F ONLY - Alpha is TOTALLY SEPARATE, no ZL data) ===
  - name: "base_prices"
    source: "staging/yahoo_historical_all_symbols.parquet"
    tests:
      - expect_date_range: ["2000-03-01", "2025-01-01"]  # ZL futures started March 2000
      - expect_symbols_count_gte: 1  # Changed from 55 - ZL=F ONLY now
      - expect_zl_rows_gte: 6000
      - expect_columns_prefixed: ["yahoo_"]  # All columns except date, symbol should have yahoo_ prefix

  # === JOIN: FRED Macro Data (PREFIXED) ===
  - name: "add_macro"
    left: "<<base_prices>>"
    right: "staging/fred_macro_expanded.parquet"  # UPDATED: New filename
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"
    tests:
      - expect_rows_preserved
      - expect_columns_added: ["fred_fed_funds_rate", "fred_vix", "fred_treasury_10y", "fred_usd_broad_index"]  # UPDATED: Prefixed columns
      - expect_null_rate_below: {"fred_fed_funds_rate": 0.05, "fred_vix": 0.05}

  # === JOIN: Weather Data (GRANULAR WIDE FORMAT) ===
  - name: "add_weather"
    left: "<<add_macro>>"
    right: "staging/weather_granular_daily.parquet"  # UPDATED: New filename (granular format)
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill: {"weather_us_iowa_prcp_mm": 0.0, "weather_us_iowa_tavg_c": 10.0}  # UPDATED: Granular column names
    tests:
      - expect_rows_preserved
      - expect_null_rate_below: {"weather_us_iowa_prcp_mm": 0.30}  # UPDATED: Granular column name
      - expect_columns_added: ["weather_us_iowa_tavg_c", "weather_us_illinois_tavg_c"]  # Verify granular columns exist

  # === JOIN: CFTC Positioning (2006+) (PREFIXED) ===
  - name: "add_cftc"
    left: "<<add_weather>>"
    right: "staging/cftc_cot_2006_2025.parquet"
    on: ["date"]
    how: "left"
    null_policy:
      allow: true  # Only available 2006+
      fill: {}
    tests:
      - expect_rows_preserved
      - expect_cftc_available_after: "2006-01-01"
      - expect_columns_prefixed: ["cftc_"]  # All columns except date should have cftc_ prefix

  # === JOIN: USDA Data (GRANULAR WIDE FORMAT) ===
  - name: "add_usda"
    left: "<<add_cftc>>"
    right: "staging/usda_reports_granular.parquet"  # UPDATED: New filename (granular format)
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"
    tests:
      - expect_rows_preserved
      - expect_columns_prefixed: ["usda_"]  # All columns except date should have usda_ prefix

  # === JOIN: EIA Energy Data (GRANULAR WIDE FORMAT) ===
  - name: "add_eia"
    left: "<<add_usda>>"
    right: "staging/eia_energy_granular.parquet"  # UPDATED: New filename (granular format)
    on: ["date"]
    how: "left"
    null_policy:
      allow: true
      fill: {}
    tests:
      - expect_rows_preserved
      - expect_columns_prefixed: ["eia_"]  # All columns except date should have eia_ prefix

  # === JOIN: Regime Assignments (CRITICAL) ===
  - name: "add_regimes"
    left: "<<add_eia>>"  # UPDATED: Changed from add_biofuels to add_eia
    right: "registry/regime_calendar.parquet"
    on: ["date"]
    how: "left"
    null_policy:
      allow: true  # Allow nulls, but fill with defaults
      fill: {"market_regime": "allhistory", "training_weight": 1}
      fill_method: "ffill"  # Forward fill for missing dates
    tests:
      - expect_rows_preserved
      - expect_regime_cardinality_gte: 7
      - expect_columns_present: ["market_regime", "training_weight"]
      - expect_null_rate_below: {"market_regime": 0.05}  # After filling, <5% nulls acceptable

  # === JOIN: Alpha Vantage Combined Data (Prices + 50+ Indicators) ===
  # POSITION: After add_regimes (last join before feature engineering)
  # NOTE: Alpha is TOTALLY SEPARATE - has NO ZL data (only CORN, WHEAT, etc.)
  # NOTE: ZL rows will get NaN for all Alpha columns (this is correct - Alpha has no ZL)
  # NOTE: This join is optional - only if Alpha data has been collected
  - name: "add_alpha_enhanced"
    left: "<<add_regimes>>"  # Join after regimes, not after FRED!
    right: "staging/alpha/daily/alpha_complete_ready_for_join.parquet"
    on: ["date", "symbol"]  # Multi-key join!
    how: "left"
    null_policy:
      allow: true
      fill_method: "ffill"  # Forward fill indicators (only for non-ZL symbols)
    tests:
      - expect_rows_preserved
      - expect_indicators_count_gte: 50  # Verify 50+ indicators added (only for non-ZL symbols)
      - expect_columns_added: ["alpha_RSI_14", "alpha_MACD_line", "alpha_ATR_14", "alpha_BBANDS_upper_20"]  # Optional - only for non-ZL symbols (prefixed)
      - expect_null_rate_below: {"alpha_RSI_14": 0.10}  # <10% nulls after ffill (only for non-ZL symbols)
      - expect_date_range: ["2000-01-01", "2025-12-31"]  # Must maintain date range

# === FINAL TESTS (Must Pass Before Feature Engineering) ===
final_tests:
  - expect_total_rows_gte: 6000
  - expect_total_cols_gte: 100
  - expect_no_duplicate_dates
  - expect_date_range: ["2000-01-01", "2025-12-31"]
  - expect_regime_cardinality_gte: 7
  - expect_weight_range: [50, 1000]  # Updated Nov 17, 2025: Changed from 50-5000 to 50-1000



