-- Backup of signals.vw_master_signal_processor
-- Created: 2025-11-17 17:57:50

WITH date_spine AS (SELECT date FROM UNNEST(GENERATE_DATE_ARRAY(DATE_SUB(CURRENT_DATE(), INTERVAL 365 DAY), CURRENT_DATE())) AS date), weather AS (SELECT date, COALESCE(brazil_drought_severity_index, 0.0) as weather_brazil_signal, COALESCE(argentina_harvest_stress_index, 0.0) as weather_argentina_signal, COALESCE(us_planting_season_stress, 0.0) as weather_us_signal, 0.4 * COALESCE(avail_brazil, 0.0) + 0.35 * COALESCE(avail_argentina, 0.0) + 0.25 * COALESCE(avail_us, 0.0) as weather_availability_weighted, CASE WHEN stale_brazil AND stale_argentina AND stale_us THEN TRUE ELSE FALSE END as weather_has_stale_data FROM `cbi-v14.signals.vw_weather_aggregates_daily_nowcast`), china_raw AS (SELECT DATE(time) as date, MAX(CASE WHEN indicator = 'cn_soy_imports_mmt' THEN LEAST(value / 10.0, 1.0) WHEN indicator = 'cn_soybean_imports_mmt_ytd' THEN LEAST(value / 100.0, 1.0) ELSE 0.0 END) as china_import_signal FROM `cbi-v14.forecasting_data_warehouse.economic_indicators` WHERE indicator LIKE '%cn_%import%' GROUP BY DATE(time)), china AS (SELECT d.date, LAST_VALUE(c.china_import_signal IGNORE NULLS) OVER (ORDER BY d.date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as china_signal FROM date_spine d LEFT JOIN china_raw c ON d.date = c.date), palm AS (SELECT date, MAX(LEAST(COALESCE(palm_substitution_signal, 0.0), 1.0)) as palm_signal_raw, MAX(LEAST(COALESCE(biofuel_economics_index, 0.0) / 10.0, 1.0)) as biofuel_signal FROM `cbi-v14.signals.vw_biofuel_substitution_aggregates_daily` GROUP BY date), palm_filled AS (SELECT d.date, LAST_VALUE(p.palm_signal_raw IGNORE NULLS) OVER (ORDER BY d.date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as palm_signal, LAST_VALUE(p.biofuel_signal IGNORE NULLS) OVER (ORDER BY d.date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as biofuel_signal FROM date_spine d LEFT JOIN palm p ON d.date = p.date), technical AS (SELECT DATE(time) as date, (LEAST(GREATEST((close - 40) / 40, -1.0), 1.0) + 1.0) / 2.0 as price_momentum_signal FROM `cbi-v14.forecasting_data_warehouse.soybean_oil_prices` QUALIFY ROW_NUMBER() OVER (PARTITION BY DATE(time) ORDER BY time DESC) = 1), technical_filled AS (SELECT d.date, LAST_VALUE(t.price_momentum_signal IGNORE NULLS) OVER (ORDER BY d.date ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW) as technical_signal FROM date_spine d LEFT JOIN technical t ON d.date = t.date), vix AS (SELECT date, vix_stress_level as vix_signal FROM `cbi-v14.signals.vw_vix_stress_daily`), signals AS (SELECT d.date, COALESCE(w.weather_brazil_signal, 0.0) as weather_brazil_signal, COALESCE(w.weather_argentina_signal, 0.0) as weather_argentina_signal, COALESCE(w.weather_us_signal, 0.0) as weather_us_signal, COALESCE(c.china_signal, 0.0) as china_signal, COALESCE(p.palm_signal, 0.0) as palm_signal, COALESCE(p.biofuel_signal, 0.0) as biofuel_signal, COALESCE(t.technical_signal, 0.0) as technical_signal, COALESCE(v.vix_signal, 0.0) as vix_signal, GREATEST(COALESCE(w.weather_availability_weighted, 0.0), 0.1) as weather_availability, COALESCE(w.weather_has_stale_data, FALSE) as weather_stale_flag, 0.25 as w_weather, 0.20 as w_china, 0.20 as w_palm, 0.20 as w_technical, 0.15 as w_vix FROM date_spine d LEFT JOIN weather w ON d.date = w.date LEFT JOIN china c ON d.date = c.date LEFT JOIN palm_filled p ON d.date = p.date LEFT JOIN technical_filled t ON d.date = t.date LEFT JOIN vix v ON d.date = v.date), fusion AS (SELECT *, w_weather * GREATEST(weather_availability, 0.3) as ww_damped, w_china * 1.0 as wc_damped, w_palm * 1.0 as wp_damped, w_technical * 1.0 as wt_damped, w_vix * 1.0 as wv_damped FROM signals) SELECT date, weather_brazil_signal, weather_argentina_signal, weather_us_signal, china_signal, palm_signal, biofuel_signal, technical_signal, vix_signal, weather_availability, weather_stale_flag, w_weather, w_china, w_palm, w_technical, w_vix, (weather_brazil_signal * ww_damped + china_signal * wc_damped + palm_signal * wp_damped + technical_signal * wt_damped + vix_signal * wv_damped) / GREATEST(ww_damped + wc_damped + wp_damped + wt_damped + wv_damped, 0.1) as master_signal_composite FROM fusion ORDER BY date DESC